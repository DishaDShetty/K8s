name: continuous-integration

on:
  push:
    branches:
    - kubestatemetrics


jobs:
  test-e2e:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s-version: ['v1.24.2']
        kubectl-version: ['v1.25.0']
        kind-version: ['v0.14.0']

    steps:
    - uses: actions/checkout@v3

    # - name: Github variables
    #   run: |
    #     echo github.event: '${{ toJson(github.event) }}'
    #     echo github.event.release.tag_name: ${{ github.event.release.tag_name }}
    #     echo github.ref: ${{ github.ref }}
    #     echo github.sha: ${{ github.sha }}
    #     echo github.head_ref: ${{ github.head_ref }}
    #     echo github.base_ref: ${{ github.base_reg }}

    # https://github.com/helm/kind-action 
    - name: Install k8s ${{ matrix.k8s-version }}
      uses: helm/kind-action@v1.8.0
      with:
        version: ${{ matrix.kind-version }}
        cluster_name: kind
        config: kind-config.yaml
        kubectl_version: ${{ matrix.kubectl-version }}
        node_image: kindest/node:${{ matrix.k8s-version }}

    - run: kubectl cluster-info

    - name: kubectl version
      run: kubectl

    - name: get deployment status
      uses: |
        kubectl apply -f kube-state-metrics-config/
        kubectl get deployments kube-state-metrics -n kube-system